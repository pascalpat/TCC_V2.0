<!-- app/templates/data_entry.html -->

{% extends "base.html" %}

{% block title %}Module Rapport Journalier{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/data_entry.css') }}">
{% endblock %}

{% block content %}
  <!-- TAB NAVIGATION -->
  <div class="tab">
    <button class="tablinks" onclick="openTab(event,'LaborEquipTab')">EmployÃ© / Ã‰quipement</button>
    <button class="tablinks" onclick="openTab(event,'MaterialsTab')">MatÃ©riaux</button>
    <button class="tablinks" onclick="openTab(event,'SubcontractorsTab')">Sous-traitants</button>
    <button class="tablinks" onclick="openTab(event,'NotesTab')">Notes du jour</button>
    <button class="tablinks" onclick="openTab(event,'PicturesTab')">Photos du jour</button>
  </div>

  <!-- PROJECT + DATE -->
  <div class="project-selection">
    <label for="projectNumber">Projet Actif:</label>
    <input type="text" id="projectNumber" value="{{ project_id }}" readonly>
    <label for="dateSelector">Date active:</label>
    <input type="date" id="dateSelector" value="{{ report_date }}" readonly>
    <a href="{{ url_for('calendar_bp.calendar_page') }}" class="btn-box">Retour au Calendrier</a>
  </div>

  <hr>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- Labor & Equipment Tab -->
  <div id="LaborEquipTab" class="tabcontent">
    <div class="form-table-container">
      <form id="WorkersForm" class="form-box">
        <h2>Ajouter un EmployÃ© ou Ã‰quipement</h2>

        <label for="workerName">SÃ©lectionner EmployÃ© / Ã‰quipement:</label>
        <select id="workerName">
          <option value="" disabled selected>-- SÃ©lectionner EmployÃ© ou Ã‰quipement --</option>
        </select>

        <div class="manual-entry-group">
          <div class="manual-toggle-group">
            <button type="button" id="manualEntryToggle">âž• Ajouter manuellement</button>
            <button type="button" id="manualEquipToggle">âž• Ajouter Ã©quipement manuellement</button>
          </div>
          <input type="text" id="manualWorkerName" placeholder="Nom travailleur manuel" class="manual-entry-input hidden">
          <input type="text" id="manualEquipmentName" placeholder="Nom Ã©quipement manuel" class="manual-entry-input hidden">
        </div>

        <label for="laborHours">Heures de travail:</label>
        <input type="number" id="laborHours" min="0" step="0.1" class="form-control">

        <label for="activityCode">Code d'ActivitÃ©:</label>
        <select id="activityCode" class="form-control" required>
          <option value="" disabled selected>-- SÃ©lectionner Code d'ActivitÃ© --</option>
          {% for code in activity_codes %}
            <option value="{{ code.id }}">{{ code.code }} â€“ {{ code.description }}</option>
          {% endfor %}
        </select>

        <label for="payment_item_id">Items de bordereau:</label>
        <select id="payment_item_id" class="form-control">
          <option value="" disabled selected>-- Aucun --</option>
          {% for item in payment_items %}
            <option value="{{ item.id }}">{{ item.payment_code }} â€“ {{ item.item_name }}</option>
          {% endfor %}
        </select>

        
        <label for="cwp_code">Construction Work Package (CWP):</label>
        <select id="cwp_code" class="form-control">
          <option value="" disabled selected>-- Aucun --</option>
          {% for c in cwps %}
            <option value="{{ c.code }}">{{ c.code }} â€“ {{ c.name }}</option>
          {% endfor %}
        </select>

        <div class="button-container">
          <button type="submit" id="addEntryBtn" class="btn btn-primary">Ajouter EntrÃ©e</button>
          <button type="button" id="confirmEntriesBtn" class="btn btn-success">Confirmer les entrÃ©es</button>
        </div>
      </form>

      <div id="workersTableContainer" class="table-container">
        <h3>Liste des EmployÃ©s / Ã‰quipements</h3>
        <table id="workersTable" class="styled-table">
          <thead>
            <tr>
              <th>Nom EmployÃ© / Ã‰quipement</th>
              <th>Heures</th>
              <th>Code d'activitÃ©</th>
              <th>Items de bordereau</th>
              <th>CWP</th>
              <th>Actions</th>  <!-- â† added this -->
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- Materials Tab -->
  <div id="MaterialsTab" class="tabcontent">
    <div class="form-table-container">
      <form id="MaterialsForm" class="form-box">
        <h2>Ajouter des MatÃ©riaux</h2>

        <label for="materialName">Nom du MatÃ©riel:</label>
        <input type="text" id="materialName" class="form-control" required>

        <label for="materialQuantity">QuantitÃ©:</label>
        <input type="number" id="materialQuantity" class="form-control" required>

        <label for="materialActivityCode">Code d'ActivitÃ©:</label>
        <select id="materialActivityCode" class="form-control">
          <option value="" disabled selected>-- SÃ©lectionner Code d'ActivitÃ© --</option>
        </select>

        <label for="materialPaymentItem">Items de bordereau:</label>
        <select id="materialPaymentItem" class="form-control">
          <option value="" disabled selected>-- Aucun --</option>
          {% for item in payment_items %}
            <option value="{{ item.id }}">{{ item.payment_code }} â€“ {{ item.item_name }}</option>
          {% endfor %}
        </select>

        <label for="materialCwp">Construction Work Package (CWP):</label>
        <select id="materialCwp" class="form-control">
          <option value="" disabled selected>-- Aucun --</option>
          {% for c in cwps %}
            <option value="{{ c.code }}">{{ c.code }} â€“ {{ c.name }}</option>
          {% endfor %}
        </select>
        
        <div class="button-container">
          <button type="button" id="addMaterialBtn" class="btn btn-primary">Ajouter MatÃ©riaux</button>
          <button type="button" id="confirmMaterialsBtn" class="btn btn-success">Confirmer les matÃ©riaux</button>
        </div>
      </form>

      <div id="materialsTableContainer" class="table-container">
        <h3>Liste des MatÃ©riaux (En session)</h3>
        <table id="materialsTable" class="styled-table">
          <thead>
            <tr>
              <th>Nom du MatÃ©riel</th>
              <th>QuantitÃ©</th>
              <th>Code d'ActivitÃ©</th>
              <th>Items de bordereau</th>
              <th>CWP</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- (other tabs unchangedâ€¦) -->
  <div id="SubcontractorsTab" class="tabcontent">â€¦</div>

     
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- nates tab -->
<div id="NotesTab" class="tabcontent" style="display:none;">
    <div class="form-table-container">

      <form id="notesDuJourForm" class="form-box" enctype="multipart/form-data">
        <h2>Notes du jour</h2>

        <!-- 1) Note content + dictation -->
        <div class="form-group">
          <label for="noteContent">Votre note :</label>
          <textarea
            id="noteContent"
            name="content"
            rows="4"
            class="form-control"
            placeholder="Entrez vos notes du jourâ€¦"
            required
          ></textarea>
          <button
            type="button"
            id="startDictation"
            class="btn btn-icon"
            title="Dicter"
          >ðŸŽ¤</button>
        </div>

        <!-- 2) Category -->
        <div class="form-group">
          <label for="noteCategory">CatÃ©gorie :</label>
          <select id="noteCategory" name="category" class="form-control">
            <option value="Progress">Avancement</option>
            <option value="Issues">ProblÃ¨me</option>
            <option value="Note">Note gÃ©nÃ©rale</option>
          </select>
        </div>

        <!-- 3) Priority -->
        <div class="form-group">
          <label for="notePriority">PrioritÃ© :</label>
          <select id="notePriority" name="priority" class="form-control">
            <option value="low">Basse</option>
            <option value="medium">Moyenne</option>
            <option value="high">Haute</option>
          </select>
        </div>

        <!-- 4) Linked activity code -->
        <div class="form-group">
          <label for="noteActivityCode">Code dâ€™activitÃ© :</label>
          <select id="noteActivityCode" name="activity_code_id" class="form-control">
            <option value="">â€” Aucun â€”</option>
            {% for ac in activity_codes %}
              <option value="{{ ac.id }}">{{ ac.code }} â€“ {{ ac.description }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 5) Linked Work Order -->
        <div class="form-group">
          <label for="noteWorkOrder">Associer WO :</label>
          <select id="noteWorkOrder" name="work_order_id" class="form-control">
            <option value="">â€” Aucun â€”</option>
            {% for wo in work_orders %}
              <option value="{{ wo.id }}">WO {{ wo.id }} â€“ {{ wo.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- 6) Attachment -->
        <div class="form-group">
          <label for="noteAttachment">PiÃ¨ce jointe (optionnelle) :</label>
          <input
            type="file"
            id="noteAttachment"
            name="attachment"
            accept=".pdf,.jpg,.jpeg,.png"
            class="form-control"
          >
        </div>

        <!-- 7) Submit -->
        <div class="button-container">
          <button
            type="submit"
            id="addNoteBtn"
            class="btn btn-primary"
          >
            Ajouter la note
          </button>
        </div>
      </form>

      <!-- List of persisted notes -->
      <div id="notesTableContainer" class="table-container">
        <h3>Historique des notes</h3>
        <table id="notesTable" class="styled-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Note</th>
              <th>CatÃ©gorie</th>
              <th>PrioritÃ©</th>
              <th>Act.</th>
              <th>WO</th>
              <th>Fichier</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  


  <div id="PicturesTab"       class="tabcontent">â€¦</div>

{% endblock %}

{% block extra_js %}
  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- 0) Core API_BASE (so fetches can pick up the script root) -->
  <script>
    // if you ever need to prefix with SCRIPT_ROOT:
    window.API_BASE = "{{ request.script_root }}";
    // make sure window.API (from base.html) still exists
    window.API = window.API || {};
  </script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- 1) Merge in this pageâ€™s labor / materials / notes endpoints -->
  <script>
    Object.assign(window.API, {
      // â”€â”€ Labor & Equipment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      listWorkers:           "{{ url_for('workers_bp.get_workers_list') }}",
      listEquipment:         "{{ url_for('equipment_bp.get_equipment_list') }}",
      listWorkersAndEquipment: "{{ url_for('labor_equipment_bp.get_pending_labor_equipment') }}",
      confirmLaborEquipment:   "{{ url_for('labor_equipment_bp.confirm_labor_equipment') }}",
      deleteLaborEntry:        type => {
          "{{ url_for('labor_equipment_bp.delete_entry', entry_type='__TYPE__', entry_id=0) }}"
            .replace('__TYPE__', type)
            .replace('0', id)
         },

      // â”€â”€ Materials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      listMaterials:           "{{ url_for('materials_bp.get_pending_materials') }}",
      confirmMaterials:        "{{ url_for('materials_bp.confirm_materials') }}",
      deleteMaterialEntry:     id => (
        "{{ url_for('materials_bp.delete_material_entry', entry_id=0) }}"
          .replace('0', id)
      ),
      updateMaterialEntry:     id => (
        "{{ url_for('materials_bp.update_material_entry', entry_id=0) }}"
          .replace('0', id)
      ),

      // â”€â”€ CWPs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      listCwps:                "{{ url_for('labor_equipment_bp.list_cw_packages') }}",

      // â”€â”€ Activity codes & payment items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      listActivityCodes:       "{{ url_for('activity_codes.get_activity_codes') }}",
      listPaymentItems:        "{{ url_for('data_entry_bp.list_payment_items') }}",

      // â”€â”€ Daily Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      listNotes:               "{{ url_for('dailynotes.list_notes') }}",
      addNote:                 "{{ url_for('dailynotes.add_note') }}",
      deleteNote:              id => (
        "{{ url_for('dailynotes.delete_note', note_id=0) }}"
          .replace('0', id)
      ),
      commitNotes:             "{{ url_for('dailynotes.commit_notes') }}",
      
      // â”€â”€ Project Id and reportDate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      projectId:  "{{ project_id }}",
      reportDate: "{{ report_date }}"
    
    });

    // legacy alias for the CWP loader
    window.CWP_LIST_URL = window.API.listCwps;
  </script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- 2) Date / Weather / Progress loader             -->
  <script type="module">
    import {
      getCurrentDate,
      highlightDates,
      getTemperature,
      restoreProgress
    } from "{{ url_for('static', filename='js/date_temp_loader.js') }}";

    document.addEventListener('DOMContentLoaded', () => {
      getCurrentDate();
      highlightDates();
      getTemperature();
      restoreProgress();
    });
  </script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- 3) Populate dropdowns & bootstrap each tab    -->
  <script type="module">
    import { populateDropdowns }    from "{{ url_for('static', filename='js/populate_drop_downs.js') }}";
    import { initLaborEquipmentTab } from "{{ url_for('static', filename='js/LaborEquipment.js') }}";
    import { initMaterialsTab       } from "{{ url_for('static', filename='js/Materials.js') }}";
    import { initDailyNotes         } from "{{ url_for('static', filename='js/notes.js') }}";

    document.addEventListener('DOMContentLoaded', async () => {
      await populateDropdowns(window.API);
      initLaborEquipmentTab(window.API);
      initMaterialsTab(window.API);
      initDailyNotes(window.API);
    });
  </script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- 4) Tab-switcher (unchanged)                   -->
  <script>
    function openTab(evt, tabName) {
      document.querySelectorAll('.tabcontent').forEach(c => c.style.display = 'none');
      document.querySelectorAll('.tablinks').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).style.display = 'block';
      evt.currentTarget.classList.add('active');
    }
    document.addEventListener('DOMContentLoaded', () => {
      const first = document.querySelector('.tablinks');
      if (first) first.click();
    });
  </script>
{% endblock %}